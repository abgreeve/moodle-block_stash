{"version":3,"file":"trade.min.js","sources":["../src/trade.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Trade module.\n *\n * @copyright  2017 Adrian Greeve - adriangreeve.com\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport base from 'block_stash/baseclass';\nimport Ajax from 'core/ajax';\nimport Log from 'core/log';\nimport Item from 'block_stash/item';\nimport UserItem from 'block_stash/user-item';\nimport * as PubSub from 'core/pubsub';\n\nexport default class Trade extends base {\n\n    /**\n     * Create a trade instance from raw data.\n     *\n     * @param {Object} tradedata Raw trade data originating from the backend.\n     */\n    constructor(tradedata) {\n        super(tradedata);\n        this.EVENT_TRADE = 'trade:pickedup';\n    }\n\n    /**\n     * Execute the trade and notify subscribers of item changes.\n     *\n     * @return {Promise<*>} Resolves with the trade response data.\n     */\n    do() {\n        return Ajax.call([{\n            methodname: 'block_stash_complete_trade',\n            args: {\n                tradeid: this.get('id'),\n                hashcode: this.get('hashcode')\n            }\n        }])[0].fail(function() {\n            Log.debug('The trade could not be completed.');\n        }).then(function(data) {\n\n            // Notify other areas about item removal and acquirement.\n            if (data) {\n                for (var index in data.gaineditems) {\n\n                    var userItem = new UserItem(data.gaineditems[index].useritem, new Item(data.gaineditems[index].item));\n                    PubSub.publish(this.EVENT_TRADE, {\n                        id: this.get('id'),\n                        hashcode: this.get('hashcode'),\n                        useritem: userItem\n                    });\n                }\n\n                for (var index in data.removeditems) {\n                    var userItem = new UserItem(data.removeditems[index].useritem, new Item(data.removeditems[index].item));\n                    PubSub.publish(this.EVENT_TRADE, {\n                        id: this.get('id'),\n                        hashcode: this.get('hashcode'),\n                        useritem: userItem\n                    });\n                }\n            }\n\n        }.bind(this));\n    }\n\n}\n"],"names":["_interopRequireDefault","e","__esModule","default","_baseclass","_ajax","_log","_item","_userItem","PubSub","t","WeakMap","r","n","o","i","f","__proto__","has","get","set","hasOwnProperty","call","Object","defineProperty","getOwnPropertyDescriptor","_interopRequireWildcard","Trade","base","constructor","tradedata","super","this","EVENT_TRADE","do","Ajax","methodname","args","tradeid","hashcode","fail","Log","debug","then","data","index","gaineditems","userItem","UserItem","useritem","Item","item","publish","id","removeditems","bind","_exports"],"mappings":"+MA2BsC,SAAAA,uBAAAC,UAAAA,GAAAA,EAAAC,WAAAD,GAAAE,QAAAF;;;;;;qFALtCG,WAAAJ,uBAAAI,YACAC,MAAAL,uBAAAK,OACAC,KAAAN,uBAAAM,MACAC,MAAAP,uBAAAO,OACAC,UAAAR,uBAAAQ,WACAC,OAAsC,SAAAR,EAAAS,yBAAAC,YAAAC,MAAAD,QAAAE,MAAAF,wBAAAV,EAAAS,OAAAA,GAAAT,GAAAA,EAAAC,kBAAAD,MAAAa,EAAAC,EAAAC,GAAAC,eAAAd,QAAAF,aAAAA,oBAAAA,sBAAAA,SAAAe,KAAAF,EAAAJ,EAAAG,EAAAD,MAAAE,EAAAI,IAAAjB,UAAAa,EAAAK,IAAAlB,GAAAa,EAAAM,IAAAnB,EAAAe,aAAAN,KAAAT,cAAAS,MAAAW,eAAAC,KAAArB,EAAAS,MAAAK,GAAAD,EAAAS,OAAAC,iBAAAD,OAAAE,yBAAAxB,EAAAS,MAAAK,EAAAI,KAAAJ,EAAAK,KAAAN,EAAAE,EAAAN,EAAAK,GAAAC,EAAAN,GAAAT,EAAAS,WAAAM,GAAAf,EAAAS,GAAtCgB,CAAAjB,QAEe,MAAMkB,cAAcC,mBAO/BC,WAAAA,CAAYC,WACRC,MAAMD,WACNE,KAAKC,YAAc,iBAQvBC,KACI,OAAOC,cAAKb,KAAK,CAAC,CACdc,WAAY,6BACZC,KAAM,CACFC,QAASN,KAAKb,IAAI,MAClBoB,SAAUP,KAAKb,IAAI,gBAEvB,GAAGqB,KAAK,WACRC,aAAIC,MAAM,uCACXC,KAAK,SAASC,MAGb,GAAIA,KAAM,CACN,IAAK,IAAIC,SAASD,KAAKE,YAAa,CAEhC,IAAIC,SAAW,IAAIC,kBAASJ,KAAKE,YAAYD,OAAOI,SAAU,IAAIC,cAAKN,KAAKE,YAAYD,OAAOM,OAC/F1C,OAAO2C,QAAQpB,KAAKC,YAAa,CAC7BoB,GAAIrB,KAAKb,IAAI,MACboB,SAAUP,KAAKb,IAAI,YACnB8B,SAAUF,WAIlB,IAAK,IAAIF,SAASD,KAAKU,aAAc,CAC7BP,SAAW,IAAIC,kBAASJ,KAAKU,aAAaT,OAAOI,SAAU,IAAIC,cAAKN,KAAKU,aAAaT,OAAOM,OACjG1C,OAAO2C,QAAQpB,KAAKC,YAAa,CAC7BoB,GAAIrB,KAAKb,IAAI,MACboB,SAAUP,KAAKb,IAAI,YACnB8B,SAAUF,cAKxBQ,KAAKvB,QAGd,OAAAwB,SAAArD,QAAAwB,MAAA6B,SAAArD,OAAA"}