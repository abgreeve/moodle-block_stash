define("block_stash/stash-area",["exports","core/ajax","block_stash/item-modal","core/pubsub","core/templates","core/str"],function(_exports,_ajax,ItemModal,PubSub,_templates,_str){function _interopRequireWildcard(e,t){if("function"==typeof WeakMap)var r=new WeakMap,n=new WeakMap;return(_interopRequireWildcard=function(e,t){if(!t&&e&&e.__esModule)return e;var o,i,f={__proto__:null,default:e};if(null===e||"object"!=typeof e&&"function"!=typeof e)return f;if(o=t?n:r){if(o.has(e))return o.get(e);o.set(e,f)}for(const t in e)"default"!==t&&{}.hasOwnProperty.call(e,t)&&((i=(o=Object.defineProperty)&&Object.getOwnPropertyDescriptor(e,t))&&(i.get||i.set)?o(f,t,i):f[t]=e[t]);return f})(e,t)}function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}
/**
   * Stash module.
   *
   * @copyright  2016 Frédéric Massart - FMCorz.net
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_ajax=_interopRequireDefault(_ajax),ItemModal=_interopRequireWildcard(ItemModal),PubSub=_interopRequireWildcard(PubSub),_templates=_interopRequireDefault(_templates);var _collections=[],_node=null;_exports.init=async courseid=>{_node=document.querySelector(".block-stash-main-block"),_collections=await getCollectionData(courseid),setUpUserItemAreClickable(),PubSub.subscribe("block_stash/drop/pickedup",dropPickedUpListener.bind(void 0)),PubSub.subscribe("trade:pickedup",dropPickedUpListener.bind(void 0))};const getCollectionData=courseid=>_ajax.default.call([{methodname:"block_stash_get_collections",args:{courseid:courseid}}])[0],setUpUserItemAreClickable=()=>{_node.querySelectorAll(".block-stash-item").forEach(function(item){makeUserItemNodeClickable(item)});const handler=e=>{if(e.target.closest(".block-stash-item")){const itemId=e.target.closest(".block-stash-item").dataset.id;if(!itemId)return;ItemModal.init(itemId),e.preventDefault()}};let itemlist=_node.querySelector(".item-list");itemlist.addEventListener("click",e=>handler(e)),itemlist.addEventListener("keydown",e=>{13!=e.keyCode&&32!=e.keyCode||handler(e)})},makeUserItemNodeClickable=node=>{node.setAttribute("tabindex",0),node.setAttribute("role","button"),node.setAttribute("aria-haspopup","true")},dropPickedUpListener=e=>{let userItem=e.useritem;containsItem(userItem.getItem().get("id"))?updateUserItemQuantity(userItem):addUserItem(userItem).then(()=>{null!==document.querySelector(".empty-content")&&document.querySelector(".empty-content").remove()})},containsItem=itemId=>_node.querySelector('.block-stash-item[data-id="'+itemId+'"]'),updateUserItemQuantity=userItem=>{_node.querySelectorAll('.block-stash-item[data-id="'+userItem.getItem().get("id")+'"]').forEach(itemnode=>{const quantityNode=itemnode.querySelector(".item-quantity"),newQuantity=userItem.get("quantity"),quantity=parseInt(quantityNode.textContent,10);if(quantityNode.textContent=newQuantity,quantityNode.style.display="block",itemnode.classList.remove("item-quantity-"+quantity),itemnode.classList.add("item-quantity-"+newQuantity),"0"==newQuantity){window.console.log("I want to know about it");const collectionids=getCollectionDisplayInfo(userItem);collectionids.length>0&&collectionids.forEach(async id=>{const collectioncontainer=_node.querySelector('.block-stash-collections[data-collectionid="'+id+'"');if(collectioncontainer){const existinglegendelement=collectioncontainer.querySelector("legend");existinglegendelement.innerText=await getCollectionString(id,!0),null!==existinglegendelement.getAttribute("style")&&(existinglegendelement.style.removeProperty("color"),existinglegendelement.style.removeProperty("border-color"))}})}})},addUserItem=userItem=>(userItem=>_templates.default.render("block_stash/user_item",{item:userItem.getItem().getData(),useritem:userItem.getData()}))(userItem).then((html,js)=>{const collectionids=getCollectionDisplayInfo(userItem),template=document.createElement("template");template.innerHTML=html;const node=template.content.firstChild,container=document.querySelector("#allitems");node.dataset.useritem=userItem,makeUserItemNodeClickable(node),container.append(" "),container.append(node),collectionids.length>0&&collectionids.forEach(async id=>{let collectionnode=node.cloneNode(!0);const collectioncontainer=_node.querySelector('.block-stash-collections[data-collectionid="'+id+'"');if(collectioncontainer){const existinglegendelement=collectioncontainer.querySelector("legend");existinglegendelement.innerText=await getCollectionString(id),collectioncontainer.appendChild(collectionnode),softCheckCollectioComplete(id)&&(existinglegendelement.style.borderColor="#088208",existinglegendelement.style.color="#088208")}else{const collectionelement=document.createElement("fieldset");collectionelement.classList.add("block-stash-collections","mb-1","p-2"),collectionelement.dataset.collectionid=id;const legendelement=document.createElement("legend");legendelement.classList.add("block-stash-collection-legend","p-1"),legendelement.innerText=await getCollectionString(id),collectionelement.appendChild(legendelement),collectionelement.appendChild(collectionnode);_node.querySelector(".block-stash-collections-area").appendChild(collectionelement)}}),_templates.default.runTemplateJS(js)}),getCollectionString=async function(collectionid){let check=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const currentcount=countCollectionItems(collectionid),collection=getInternalCollectionData(collectionid);let collectedcount=check?currentcount:parseInt(currentcount+1);const data={name:collection.collection.name,collected:collectedcount,total:collection.items.length};return await(0,_str.get_string)("collected","block_stash",data)},countCollectionItems=collectionid=>{const collectioncontainer=_node.querySelector('.block-stash-collections[data-collectionid="'+collectionid+'"');if(!collectioncontainer)return 0;const items=collectioncontainer.querySelectorAll(".block-stash-item");let collectioncount=items.length;return items.forEach(item=>{"0"==item.querySelector(".item-quantity").innerText&&collectioncount--}),collectioncount},softCheckCollectioComplete=collectionid=>{const currentcount=countCollectionItems(collectionid);return getInternalCollectionData(collectionid).items.length==currentcount},getInternalCollectionData=collectionid=>{let collectionresult=null;return _collections.forEach(collection=>{collection.collection.id==collectionid&&(collectionresult=collection)}),collectionresult},getCollectionDisplayInfo=userItem=>{let data=[];return _collections.forEach(collection=>{collection.items.forEach(item=>{if(item.id==userItem.getItem().get("id")){const quick=collection.collection;data.push(quick.id)}})}),data}});

//# sourceMappingURL=stash-area.min.js.map