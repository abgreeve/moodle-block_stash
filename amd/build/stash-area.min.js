define("block_stash/stash-area",["exports","core/ajax","block_stash/item-modal","core/pubsub","core/templates"],(function(_exports,_ajax,ItemModal,PubSub,_templates){function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}return newObj.default=obj,cache&&cache.set(obj,newObj),newObj}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
<<<<<<< HEAD
 * Stash module.
 *
 * @copyright  2016 Frédéric Massart - FMCorz.net
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("block_stash/stash-area",["jquery","core/templates","block_stash/item-modal","block_stash/drop","block_stash/trade","core/pubsub"],function($,Templates,ItemModal,Drop,Trade,PubSub){function StashArea(node){this._node=$(node),this._setUp()}return StashArea.prototype._node=null,StashArea.prototype._userItemTemplate="block_stash/user_item",StashArea.prototype._setUp=function(){PubSub.subscribe("block_stash/drop/pickedup",this._dropPickedUpListener.bind(this)),PubSub.subscribe("trade:pickedup",this._dropPickedUpListener.bind(this)),this._setUpUserItemAreClickable()},StashArea.prototype.addUserItem=function(userItem){return this._renderUserItem(userItem).then(function(html,js){var node=$(html),container=this._node.find(".item-list");node.data("useritem",userItem),this._makeUserItemNodeClickable(node),container.append(" "),container.append(node),Templates.runTemplateJS(js)}.bind(this))},StashArea.prototype.containsItem=function(id){return this.getUserItemNode(id).length>0},StashArea.prototype._dropPickedUpListener=function(e){var userItem=e.useritem;this.containsItem(userItem.getItem().get("id"))?this.updateUserItemQuantity(userItem):this.addUserItem(userItem).then(function(){this._node.find(".empty-content").remove()}.bind(this))},StashArea.prototype.getUserItemNode=function(id){return this._node.find(".block-stash-item[data-id="+id+"]")},StashArea.prototype._makeUserItemNodeClickable=function(node){node.attr("tabindex",0),node.attr("role","button"),node.attr("aria-haspopup","true")},StashArea.prototype._renderUserItem=function(userItem){return Templates.render(this._userItemTemplate,{item:userItem.getItem().getData(),useritem:userItem.getData()})},StashArea.prototype._setUpUserItemAreClickable=function(){this._node.find(".item-list .block-stash-item").each(function(i,node){this._makeUserItemNodeClickable($(node))}.bind(this));var handler=function(e){var itemId=$(e.currentTarget).data("id");itemId&&(ItemModal.init(itemId),e.preventDefault())},selector='.block-stash-item[aria-haspopup="true"]';this._node.find(".item-list").delegate(selector,"click",handler),this._node.find(".item-list").delegate(selector,"keydown",function(e){13!=e.keyCode&&32!=e.keyCode||handler(e)})},StashArea.prototype.updateUserItemQuantity=function(userItem){var node=this.getUserItemNode(userItem.getItem().get("id")),quantityNode=node.find(".item-quantity"),newQuantity=userItem.get("quantity"),quantity=parseInt(quantityNode.text(),10);quantityNode.text(newQuantity),node.removeClass("item-quantity-"+quantity),node.addClass("item-quantity-"+newQuantity)},StashArea});
=======
   * Stash module.
   *
   * @copyright  2016 Frédéric Massart - FMCorz.net
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_ajax=_interopRequireDefault(_ajax),ItemModal=_interopRequireWildcard(ItemModal),PubSub=_interopRequireWildcard(PubSub),_templates=_interopRequireDefault(_templates);var _collections=[];_exports.init=async courseid=>{_collections=await getCollectionData(courseid),setUpUserItemAreClickable(),PubSub.subscribe("block_stash/drop/pickedup",dropPickedUpListener.bind(void 0)),PubSub.subscribe("trade:pickedup",dropPickedUpListener.bind(void 0))};const getCollectionData=courseid=>_ajax.default.call([{methodname:"block_stash_get_collections",args:{courseid:courseid}}])[0],setUpUserItemAreClickable=()=>{document.querySelectorAll(".block-stash-item").forEach((function(item){makeUserItemNodeClickable(item)}));const handler=e=>{if(e.target.closest(".block-stash-item")){const itemId=e.target.closest(".block-stash-item").dataset.id;if(!itemId)return;ItemModal.init(itemId),e.preventDefault()}};let itemlist=document.querySelector(".item-list");itemlist.addEventListener("click",(e=>handler(e))),itemlist.addEventListener("keydown",(e=>{13!=e.keyCode&&32!=e.keyCode||handler(e)}))},makeUserItemNodeClickable=node=>{node.setAttribute("tabindex",0),node.setAttribute("role","button"),node.setAttribute("aria-haspopup","true")},dropPickedUpListener=e=>{let userItem=e.useritem;containsItem(userItem.getItem().get("id"))?updateUserItemQuantity(userItem):addUserItem(userItem).then((()=>{null!==document.querySelector(".empty-content")&&document.querySelector(".empty-content").remove()}))},containsItem=itemId=>document.querySelector('.block-stash-item[data-id="'+itemId+'"]'),updateUserItemQuantity=userItem=>{const itemnode=document.querySelector('.block-stash-item[data-id="'+userItem.getItem().get("id")+'"]'),quantityNode=itemnode.querySelector(".item-quantity"),newQuantity=userItem.get("quantity"),quantity=parseInt(quantityNode.textContent,10);quantityNode.textContent=newQuantity,quantityNode.style.display="block",itemnode.classList.remove("item-quantity-"+quantity),itemnode.classList.add("item-quantity-"+newQuantity)},addUserItem=userItem=>(userItem=>_templates.default.render("block_stash/user_item",{item:userItem.getItem().getData(),useritem:userItem.getData()}))(userItem).then(((html,js)=>{window.console.log(_collections);const template=document.createElement("template");template.innerHTML=html;const node=template.content.firstChild,container=document.querySelector("#allitems");node.dataset.useritem=userItem,makeUserItemNodeClickable(node),container.append(" "),container.append(node),_templates.default.runTemplateJS(js)}))}));
>>>>>>> b36a8b6 (Web service and re-write of stash-area js)

//# sourceMappingURL=stash-area.min.js.map