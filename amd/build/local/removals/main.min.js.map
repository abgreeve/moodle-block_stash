{"version":3,"file":"main.min.js","sources":["../../../src/local/removals/main.js"],"sourcesContent":["import ModalFactory from 'core/modal_factory';\nimport ModalEvents from 'core/modal_events';\nimport Templates from 'core/templates';\nimport * as tradeAdder from 'block_stash/local/trade_adder/main';\nimport Ajax from 'core/ajax';\n\nconst showModal = async(courseid) => {\n    const modal = await buildModal(courseid);\n    displayModal(modal, courseid);\n};\n\nconst buildModal = async(courseid) => {\n\n    // Fetch quizzes.\n    let quizzes = await fetchItemData(courseid);\n\n    // let items = await Item.getItem(itemId);\n    // let context = items.getData();\n    let context = {'courseid': courseid, 'quizzes': quizzes.activities};\n\n    return ModalFactory.create({\n        title: context.name,\n        body: Templates.render('block_stash/local/removal/removal_form', context),\n        type: ModalFactory.types.SAVE_CANCEL\n    });\n};\n\nconst displayModal = async(modal, courseid) => {\n\n    modal.getRoot().on(ModalEvents.bodyRendered, () => {\n        tradeAdder.init();\n    });\n\n    modal.getRoot().on(ModalEvents.save, () => {\n        saveData(courseid);\n    });\n\n    modal.getRoot().on(ModalEvents.hidden, () => {\n        modal.destroy();\n    });\n    modal.show();\n};\n\nconst saveData = async (courseid) => {\n    let itemsinfo = document.querySelectorAll('.block-stash-quantity');\n    let items = [];\n    let returnitemdata = [];\n    itemsinfo.forEach((item) => {\n        let itemid = item.closest('.block-stash-trade-item').getAttribute('data-id');\n        let basedata = {\n            'itemid': parseInt(itemid),\n            'quantity': parseInt(item.value)\n        };\n        // Do it again, but duplicating objects just ends up with a reference which is not what I want.\n        let fulldata = {\n            'itemid': parseInt(itemid),\n            'quantity': parseInt(item.value),\n            'name': item.closest('.block-stash-trade-item').children[0].innerText.trim()\n        };\n        items.push(basedata);\n        returnitemdata.push(fulldata);\n    });\n    let quizselect = document.querySelector('.block-stash-quiz-select');\n    let cmid = quizselect.value;\n    let removalid = await saveRemovalEntry(courseid, parseInt(cmid), items);\n    let context = {\n        'cmname': quizselect.item(quizselect.selectedIndex).text,\n        'courseid': courseid,\n        'removalid': removalid,\n        'items': returnitemdata\n    };\n    // window.console.log(context);\n    Templates.render('block_stash/local/removal/table_row', context).then((html, js) => {\n        let tableobject = document.querySelector('.block-stash-removal-body');\n        let things = Templates.appendNodeContents(tableobject, html, js);\n        registerDeleteEvent(courseid, things[0].querySelector('.block-stash-removal-icon'));\n    });\n};\n\nconst registerDeleteEvent = (courseid, deleteobject) => {\n    deleteobject.addEventListener('click', (e) => {\n        e.preventDefault();\n        let deletionelement = e.currentTarget;\n        window.console.log(deletionelement);\n        let removalid = deletionelement.dataset.id;\n        // Make ajax request to delete this removal configuration.\n        window.console.log(courseid);\n        window.console.log(removalid);\n        deleteRemovalEntry(courseid, parseInt(removalid)).then(() => {\n            // If the request was okay then remove the table row.\n            let row = deletionelement.closest('tr');\n            row.remove();\n        });\n    });\n};\n\nexport const init = (courseid) => {\n\n    let configbutton = document.querySelector('.block-config-removal');\n    configbutton.addEventListener('click', (e) => {\n        e.preventDefault();\n        showModal(courseid);\n    });\n\n    let deletebutton = document.querySelectorAll('.block-stash-removal-icon');\n    deletebutton.forEach((deleteobject) => {\n        registerDeleteEvent(courseid, deleteobject);\n    });\n};\n\nconst fetchItemData = (courseid) => Ajax.call([{\n    methodname: 'block_stash_get_removal_activities',\n    args: {courseid: courseid}\n}])[0];\n\nconst saveRemovalEntry = (courseid, cmid, items) => Ajax.call([{\n    methodname: 'block_stash_save_removal',\n    args: {'courseid': courseid, 'cmid': cmid, 'items': items}\n}])[0];\n\nconst deleteRemovalEntry = (courseid, removalid) => Ajax.call([{\n    methodname: 'block_stash_delete_removal',\n    args: {'courseid': courseid, 'removalid': removalid}\n}])[0];\n"],"names":["buildModal","async","context","courseid","fetchItemData","activities","ModalFactory","create","title","name","body","Templates","render","type","types","SAVE_CANCEL","displayModal","modal","getRoot","on","ModalEvents","bodyRendered","tradeAdder","init","save","saveData","hidden","destroy","show","itemsinfo","document","querySelectorAll","items","returnitemdata","forEach","item","itemid","closest","getAttribute","basedata","parseInt","value","fulldata","children","innerText","trim","push","quizselect","querySelector","cmid","removalid","saveRemovalEntry","selectedIndex","text","then","html","js","tableobject","things","appendNodeContents","registerDeleteEvent","deleteobject","addEventListener","e","preventDefault","deletionelement","currentTarget","window","console","log","dataset","id","deleteRemovalEntry","remove","showModal","Ajax","call","methodname","args"],"mappings":"qgDAWMA,WAAaC,MAAAA,eAOXC,QAAU,UAAaC,wBAJPC,cAAcD,WAIsBE,mBAEjDC,uBAAaC,OAAO,CACvBC,MAAON,QAAQO,KACfC,KAAMC,mBAAUC,OAAO,yCAA0CV,SACjEW,KAAMP,uBAAaQ,MAAMC,eAI3BC,aAAef,MAAMgB,MAAOd,YAE9Bc,MAAMC,UAAUC,GAAGC,sBAAYC,cAAc,KACzCC,WAAWC,UAGfN,MAAMC,UAAUC,GAAGC,sBAAYI,MAAM,KACjCC,SAAStB,aAGbc,MAAMC,UAAUC,GAAGC,sBAAYM,QAAQ,KACnCT,MAAMU,aAEVV,MAAMW,QAGJH,SAAWxB,MAAAA,eACT4B,UAAYC,SAASC,iBAAiB,yBACtCC,MAAQ,GACRC,eAAiB,GACrBJ,UAAUK,SAASC,WACXC,OAASD,KAAKE,QAAQ,2BAA2BC,aAAa,WAC9DC,SAAW,QACDC,SAASJ,iBACPI,SAASL,KAAKM,QAG1BC,SAAW,QACDF,SAASJ,iBACPI,SAASL,KAAKM,YAClBN,KAAKE,QAAQ,2BAA2BM,SAAS,GAAGC,UAAUC,QAE1Eb,MAAMc,KAAKP,UACXN,eAAea,KAAKJ,iBAEpBK,WAAajB,SAASkB,cAAc,4BACpCC,KAAOF,WAAWN,MAClBS,gBAAkBC,iBAAiBhD,SAAUqC,SAASS,MAAOjB,OAC7D9B,QAAU,QACA6C,WAAWZ,KAAKY,WAAWK,eAAeC,cACxClD,mBACC+C,gBACJjB,mCAGHrB,OAAO,sCAAuCV,SAASoD,MAAK,CAACC,KAAMC,UACrEC,YAAc3B,SAASkB,cAAc,6BACrCU,OAAS/C,mBAAUgD,mBAAmBF,YAAaF,KAAMC,IAC7DI,oBAAoBzD,SAAUuD,OAAO,GAAGV,cAAc,kCAIxDY,oBAAsB,CAACzD,SAAU0D,gBACnCA,aAAaC,iBAAiB,SAAUC,IACpCA,EAAEC,qBACEC,gBAAkBF,EAAEG,cACxBC,OAAOC,QAAQC,IAAIJ,qBACff,UAAYe,gBAAgBK,QAAQC,GAExCJ,OAAOC,QAAQC,IAAIlE,UACnBgE,OAAOC,QAAQC,IAAInB,WACnBsB,mBAAmBrE,SAAUqC,SAASU,YAAYI,MAAK,KAEzCW,gBAAgB5B,QAAQ,MAC9BoC,8BAKKtE,WAEE2B,SAASkB,cAAc,yBAC7Bc,iBAAiB,SAAUC,IACpCA,EAAEC,iBA9FQ/D,OAAAA,iBACRgB,YAAcjB,WAAWG,UAC/Ba,aAAaC,MAAOd,WA6FhBuE,CAAUvE,aAGK2B,SAASC,iBAAiB,6BAChCG,SAAS2B,eAClBD,oBAAoBzD,SAAU0D,wBAIhCzD,cAAiBD,UAAawE,cAAKC,KAAK,CAAC,CAC3CC,WAAY,qCACZC,KAAM,CAAC3E,SAAUA,aACjB,GAEEgD,iBAAmB,CAAChD,SAAU8C,KAAMjB,QAAU2C,cAAKC,KAAK,CAAC,CAC3DC,WAAY,2BACZC,KAAM,UAAa3E,cAAkB8C,WAAejB,UACpD,GAEEwC,mBAAqB,CAACrE,SAAU+C,YAAcyB,cAAKC,KAAK,CAAC,CAC3DC,WAAY,6BACZC,KAAM,UAAa3E,mBAAuB+C,cAC1C"}