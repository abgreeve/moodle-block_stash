{"version":3,"file":"main.min.js","sources":["../../../src/local/removals/main.js"],"sourcesContent":["import Modal from 'core/modal_save_cancel';\nimport ModalEvents from 'core/modal_events';\nimport Templates from 'core/templates';\nimport * as tradeAdder from 'block_stash/local/trade_adder/main';\nimport Ajax from 'core/ajax';\nimport * as getItems from 'block_stash/local/datasources/items-getter';\nimport {get_string as getString} from 'core/str';\nimport * as Toast from 'core/toast';\n\nconst showModal = async(courseid, editdetails = []) => {\n    const modal = await buildModal(courseid, editdetails);\n    displayModal(modal, courseid);\n};\n\nconst buildModal = async(courseid, editdetails) => {\n\n    // Fetch quizzes.\n    let quizzes = await fetchQuizData(courseid);\n\n    quizzes.activities.forEach((quiz) => {\n        quiz['selected'] = false;\n        if (editdetails.length !== 0) {\n            if (quiz.id == editdetails.quizid) {\n                quiz['selected'] = true;\n            }\n        }\n    });\n\n    let context = {'courseid': courseid, 'quizzes': quizzes.activities};\n    if (editdetails.length !== 0) {\n        let allitems = await getItems.getIndexedItems(courseid);\n        let additemsdata = [];\n        editdetails.items.forEach((item) => {\n            additemsdata.push(\n                {\n                    'itemid': item.itemid,\n                    'name': allitems[item.itemid].name,\n                    'quantity': item.quantity,\n                    'imageurl': allitems[item.itemid].imageurl\n                }\n            );\n        });\n        context['additems'] = additemsdata;\n        context['removalid'] = editdetails.removalid;\n    }\n    window.console.log(context);\n\n    return Modal.create({\n        title: getString('configureremoval', 'block_stash'),\n        body: Templates.render('block_stash/local/removal/removal_form', context),\n    });\n};\n\nconst displayModal = async(modal, courseid) => {\n\n    modal.getRoot().on(ModalEvents.bodyRendered, () => {\n        tradeAdder.init();\n        tradeAdder.registerActions();\n    });\n\n    modal.getRoot().on(ModalEvents.save, () => {\n        saveData(courseid);\n    });\n\n    modal.getRoot().on(ModalEvents.hidden, () => {\n        modal.destroy();\n    });\n    modal.show();\n};\n\nconst saveData = async (courseid) => {\n    let itemsinfo = document.querySelectorAll('.block-stash-quantity');\n    let items = [];\n    let returnitemdata = [];\n    itemsinfo.forEach((item) => {\n        let itemid = item.closest('.block-stash-trade-item').getAttribute('data-id');\n        let basedata = {\n            'itemid': parseInt(itemid),\n            'quantity': parseInt(item.value)\n        };\n        // Do it again, but duplicating objects just ends up with a reference which is not what I want.\n        let fulldata = {\n            'itemid': parseInt(itemid),\n            'quantity': parseInt(item.value),\n            'name': item.closest('.block-stash-trade-item').children[0].innerText.trim()\n        };\n        items.push(basedata);\n        returnitemdata.push(fulldata);\n    });\n    let quizselect = document.querySelector('.block-stash-quiz-select');\n    let cmid = quizselect.value;\n    if (cmid === '0') {\n        await Toast.addToastRegion(document.querySelector('.modal-body'));\n        Toast.add(getString('selectquizcheck', 'block_stash'), {\n            type: 'danger',\n            autohide: true,\n            closeButton: true,\n        });\n        return false;\n    }\n    let removalid = 0;\n    let removalelement = document.getElementById('block_stash_removal_id');\n    if (removalelement) {\n        removalid = updateRemovalEntry(courseid, parseInt(cmid), items, removalelement.dataset.id).then(() => {\n            Toast.add(getString('configupdated', 'block_stash'), {\n                type: 'info',\n                autohide: true,\n                closeButton: true,\n            });\n        });\n    } else {\n        removalid = await saveRemovalEntry(courseid, parseInt(cmid), items);\n    }\n\n    let context = {\n        'cmid': cmid,\n        'cmname': quizselect.item(quizselect.selectedIndex).text,\n        'courseid': courseid,\n        'removalid': removalid,\n        'items': returnitemdata,\n        'editinfo': JSON.stringify(items)\n    };\n    // window.console.log(context);\n    Templates.render('block_stash/local/removal/table_row', context).then((html, js) => {\n        if (!removalelement) {\n            let tableobject = document.querySelector('.block-stash-removal-body');\n            let things = Templates.appendNodeContents(tableobject, html, js);\n            registerDeleteEvent(courseid, things[0].querySelector('.block-stash-removal-icon'));\n            registerEditEvent(courseid, things[0].querySelector('.block-stash-removal-edit'));\n        } else {\n            let rowelement = document.querySelector('.block-stash-removal-edit[data-id=\"' + removalid + '\"');\n            let tmpe = rowelement.closest('tr');\n            let things = Templates.replaceNode(tmpe, html, js);\n            registerDeleteEvent(courseid, things[0].querySelector('.block-stash-removal-icon'));\n            registerEditEvent(courseid, things[0].querySelector('.block-stash-removal-edit'));\n        }\n    });\n};\n\nconst registerDeleteEvent = (courseid, deleteobject) => {\n    deleteobject.addEventListener('click', (e) => {\n        e.preventDefault();\n        let deletionelement = e.currentTarget;\n        let removalid = deletionelement.dataset.id;\n        // Make ajax request to delete this removal configuration.\n        deleteRemovalEntry(courseid, parseInt(removalid)).then(() => {\n            // If the request was okay then remove the table row.\n            let row = deletionelement.closest('tr');\n            row.remove();\n            Toast.add(getString('configdeleted', 'block_stash'), {\n                type: 'info',\n                autohide: true,\n                closeButton: true,\n            });\n        });\n    });\n};\n\nconst registerEditEvent = (courseid, editobject) => {\n    editobject.addEventListener('click', (e) => {\n        e.preventDefault();\n        let jsondata = JSON.parse(editobject.dataset.json);\n        let details = {'removalid': editobject.dataset.id, 'quizid': editobject.dataset.quiz, 'items': jsondata};\n        showModal(courseid, details);\n    });\n};\n\nexport const init = (courseid) => {\n\n    let configbutton = document.querySelector('.block-config-removal');\n    configbutton.addEventListener('click', (e) => {\n        e.preventDefault();\n        showModal(courseid);\n    });\n\n    let deletebutton = document.querySelectorAll('.block-stash-removal-icon');\n    deletebutton.forEach((deleteobject) => {\n        registerDeleteEvent(courseid, deleteobject);\n    });\n\n    let editbutton = document.querySelectorAll('.block-stash-removal-edit');\n    editbutton.forEach((editobject) => {\n        registerEditEvent(courseid, editobject);\n    });\n};\n\nconst fetchQuizData = (courseid) => Ajax.call([{\n    methodname: 'block_stash_get_removal_activities',\n    args: {courseid: courseid}\n}])[0];\n\nconst saveRemovalEntry = (courseid, cmid, items) => Ajax.call([{\n    methodname: 'block_stash_save_removal',\n    args: {'courseid': courseid, 'cmid': cmid, 'items': items}\n}])[0];\n\nconst updateRemovalEntry = (courseid, cmid, items, removalid) => Ajax.call([{\n    methodname: 'block_stash_save_removal',\n    args: {'courseid': courseid, 'cmid': cmid, 'items': items, 'removalid': removalid}\n}])[0];\n\nconst deleteRemovalEntry = (courseid, removalid) => Ajax.call([{\n    methodname: 'block_stash_delete_removal',\n    args: {'courseid': courseid, 'removalid': removalid}\n}])[0];\n"],"names":["_interopRequireWildcard","e","t","WeakMap","r","n","__esModule","o","i","f","__proto__","default","has","get","set","hasOwnProperty","call","Object","defineProperty","getOwnPropertyDescriptor","_interopRequireDefault","_modal_save_cancel","_modal_events","_templates","tradeAdder","_ajax","getItems","Toast","showModal","async","courseid","editdetails","arguments","length","undefined","modal","buildModal","displayModal","quizzes","fetchQuizData","activities","forEach","quiz","id","quizid","context","allitems","getIndexedItems","additemsdata","items","item","push","itemid","name","quantity","imageurl","removalid","window","console","log","Modal","create","title","getString","body","Templates","render","getRoot","on","ModalEvents","bodyRendered","init","registerActions","save","saveData","hidden","destroy","show","itemsinfo","document","querySelectorAll","returnitemdata","closest","getAttribute","basedata","parseInt","value","fulldata","children","innerText","trim","quizselect","querySelector","cmid","addToastRegion","add","type","autohide","closeButton","removalelement","getElementById","updateRemovalEntry","dataset","then","saveRemovalEntry","cmname","selectedIndex","text","editinfo","JSON","stringify","html","js","tmpe","things","replaceNode","registerDeleteEvent","registerEditEvent","tableobject","appendNodeContents","deleteobject","addEventListener","preventDefault","deletionelement","currentTarget","deleteRemovalEntry","remove","editobject","jsondata","parse","json","details","_exports","Ajax","methodname","args"],"mappings":"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"}